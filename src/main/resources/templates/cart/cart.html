<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <link rel="stylesheet" th:href="@{/css/cartadd.css}">
</head>
<body>
<!-- í—¤ë”ë¥¼ fragmentë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. -->
<div th:replace="~{fragments/header :: header}"></div>

<main>
    <div th:if="${#lists.size(cartItems) == 0}" class="cart-container">
        <h1>ì¥ë°”êµ¬ë‹ˆ</h1>
        <div class="cart-icon">ğŸ›’</div>
        <p class="cart-message">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.<br>ì›í•˜ì‹œëŠ” ìˆ™ì†Œë¥¼ ë‹´ì•„ì£¼ì„¸ìš”.</p>

        <!-- âœ… ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ -->
        <a href="/" class="button">ë‹´ìœ¼ëŸ¬ ê°€ê¸°</a>

        <!-- âœ… ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ì¶”ê°€í•˜ëŠ” ë²„íŠ¼ -->
        <form th:action="@{/cart/add}" method="post" onsubmit="redirectToCart(event)">
            <input type="hidden" name="acmId" value="1"> <!-- ì˜ˆì œ ìˆ™ì†Œ ID -->

        </form>
    </div>





    <div th:if="${#lists.size(cartItems) > 0}" class="cart-add-container">
        <div class="cart-add-header">
            <div>
                <label for="all">
                    <input type="checkbox" name="all" value="all" onclick='selectAll(this)' id="all">
                    ì „ì²´ì„ íƒ
                </label>
            </div>
            <div>ì¥ë°”êµ¬ë‹ˆ</div>
            <div style="cursor: pointer" onclick="deleteItems()">ì„ íƒ ì‚­ì œ</div>
        </div>
        <div class="cart-add-body" th:each="item : ${cartItems}">
            <label style="cursor: pointer" th:for="${item.acmId}">
                <div class="cart-add-body-header">
                    <input type="checkbox" name="acmName" th:value="${item.acmPrice}" th:id="${item.acmId}" onclick="getCheckBoxValues()">
                    <div class="cart-add-body-header-name" th:text="${item.acmName}"></div>
                </div>
                <div class="cart-add-body-line"></div>
                <div class="cart-add-body-content">
                    <img th:src="@{${item.acmPhoto1}}" width="300px" height="240px">
                    <div th:text="${#numbers.formatDecimal(item.acmPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'"></div>
                </div>
            </label>
        </div>
        <div class="cart-add-footer">
            <div th:text="'ì´' + 'ê±´'"></div>
            <div class="cart-add-price-result">
                <div>ê²°ì œ ê¸ˆì•¡ì˜ˆìƒ</div>
                <div id="total-price"></div>
            </div>
            <div class="cart-add-purchase" onclick="goToPurchase()">êµ¬ë§¤í•˜ê¸°</div>
        </div>
    </div>
</main>

<!-- í‘¸í„°ë¥¼ fragmentë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="/js/header.js"></script>

<!-- âœ… ìƒí’ˆ ì¶”ê°€ í›„ ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    function redirectToCart(event) {
        event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë™ì‘ ë§‰ê¸°

        fetch(event.target.action, {
            method: "POST",
            body: new FormData(event.target)
        }).then(response => {
            if (response.ok) {
                alert("ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/cart"; // ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™
            }
        });
    }

    function getSelectedItems() {
        let selectedItems = Array.from(document.querySelectorAll('input[name="acmName"]:checked'));

        return selectedItems.map(checkbox => Number(checkbox.id));
    }

    function goToPurchase() {
        let selectedIds = getSelectedItems();

        console.log(selectedIds)

        fetch("/payment", {     // ë§µí•‘ ì£¼ì†Œ
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(
                selectedIds
            ),
        });
    }


    function deleteItems(event) {
        let selectedIds = getSelectedItems();

        console.log(selectedIds);

        fetch("/cart/delete", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(
                selectedIds
            ),
        }).then(response => {
            location.reload();
        })
    }

    function selectAll(selectAll)  {
        const checkboxes
            = document.querySelectorAll('input[type="checkbox"]');

        checkboxes.forEach((checkbox) => {
            checkbox.checked = selectAll.checked
        })

        getCheckBoxValues();
    }

    function getCheckBoxValues() {
        let selectedItems = Array.from(document.querySelectorAll('input[name="acmName"]:checked'));



        let totalPrice = selectedItems
            .map(checkbox => Number(checkbox.value))
            .reduce((acc, curr) => acc + curr, 0);

        document.getElementById('total-price').innerText = totalPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + 'ì›';
    }

    document.addEventListener("DOMContentLoaded", function () {
        updateTotalPrice();

        // ê°œë³„ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì¥ë°”êµ¬ë‹ˆ ì—…ë°ì´íŠ¸
        document.querySelectorAll(".delete-item").forEach(button => {
            button.addEventListener("click", function () {
                setTimeout(updateTotalPrice, 500);
            });
        });

        // ì „ì²´ ì‚­ì œ ë²„íŠ¼
        document.getElementById("clear-cart").addEventListener("click", function () {
            if (confirm("ì •ë§ë¡œ ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch("/cart/deleteAll", { method: "POST" })
                    .then(response => {
                        if (response.ok) {
                            alert("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤.");
                            location.reload();
                        }
                    });
            }
        });

        // ì´ ê°€ê²© ê³„ì‚° í•¨ìˆ˜
        function updateTotalPrice() {
            let totalPrice = 0;
            document.querySelectorAll(".item-price").forEach(item => {
                totalPrice += parseInt(item.getAttribute("data-price")) || 0;
            });
            document.getElementById("total-price").textContent = totalPrice.toLocaleString() + "ì›";
        }

        // âœ… ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì¥ë°”êµ¬ë‹ˆ ì •ë³´ JSONìœ¼ë¡œ ë³€í™˜ í›„ ì „ì†¡
        document.getElementById("checkout").addEventListener("click", function (event) {
            event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë™ì‘ ë§‰ê¸°

            let cartItems = [];
            document.querySelectorAll("tbody tr").forEach(row => {
                let acmId = row.querySelector("input[name='acmId']").value;
                let acmName = row.cells[1].textContent;
                let acmPrice = row.cells[2].textContent.replace("ì›", "").trim();
                cartItems.push({ acmId, acmName, acmPrice });
            });

            document.getElementById("cartItemsJson").value = JSON.stringify(cartItems);
            document.getElementById("payment-form").submit();
        });

    });
</script>
</body>
</html>
